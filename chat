<!DOCTYPE html>
<html>
<head>
    <title>聊天室中转站</title>
    <script>
        // 获取URL参数
        function getParam(name) {
            return new URLSearchParams(window.location.search).get(name);
        }
        
        // 主函数
        window.onload = function() {
            const action = getParam('action');
            const user = getParam('user') || '匿名';
            const message = getParam('msg') || '';
            const time = new Date().toLocaleTimeString();
            
            if (action === 'send') {
                // 发送消息
                let messages = JSON.parse(localStorage.getItem('chat_messages') || '[]');
                messages.push({
                    user: user,
                    message: message,
                    time: time,
                    timestamp: Date.now()
                });
                
                // 只保留最近50条消息
                if (messages.length > 50) {
                    messages = messages.slice(-50);
                }
                
                localStorage.setItem('chat_messages', JSON.stringify(messages));
                localStorage.setItem('last_update', Date.now());
                
                // 返回成功
                document.body.innerHTML = 'OK';
                
            } else if (action === 'get') {
                // 获取消息
                let messages = JSON.parse(localStorage.getItem('chat_messages') || '[]');
                const lastTime = parseInt(getParam('last') || '0');
                
                // 过滤新消息
                const newMessages = messages.filter(msg => msg.timestamp > lastTime);
                
                // 返回JSON
                document.body.innerHTML = JSON.stringify({
                    messages: newMessages,
                    last_update: localStorage.getItem('last_update') || '0'
                });
            }
        };
    </script>
</head>
<body></body>
</html>
